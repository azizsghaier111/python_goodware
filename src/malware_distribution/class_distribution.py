import os
import subprocess

# Directory containing the JSON reports
REPORTS_DIRECTORY = "src/malware_distribution/reports"
OUTPUT_DIRECTORY = "src/malware_distribution/"
OUTPUT_FILE = os.path.join(OUTPUT_DIRECTORY, "classes.txt")

# Ensure the output directory exists
if not os.path.exists(OUTPUT_DIRECTORY):
    os.makedirs(OUTPUT_DIRECTORY)


def run_avclass(json_file):
    # Run the AVClass command and capture the output
    command = f"avclass -f {os.path.join(REPORTS_DIRECTORY, json_file)}"

    try:
        # Execute the command and capture the output
        result = subprocess.run(command, shell=True, check=True, capture_output=True, text=True)
        return result.stdout
    except subprocess.CalledProcessError as e:
        print(f"Error running AVClass on {json_file}: {e}")
        return None


if __name__ == "__main__":
    # Open the output file in append mode
    with open(OUTPUT_FILE, "a") as output_file:
        # Loop through all JSON files in the reports directory
        for json_file in os.listdir(REPORTS_DIRECTORY):
            if json_file.endswith(".json"):
                print(f"Processing {json_file}...")

                # Run AVClass on the JSON file and get the output
                avclass_output = run_avclass(json_file)

                if avclass_output:
                    # Display the output in the console
                    print(f"\nResults for {json_file}:\n")
                    print(avclass_output)
                    print("=" * 40)  # Separator for readability

                    # Write the file name and the corresponding AVClass output to the output file
                    output_file.write(f"Results for {json_file}:\n")
                    output_file.write(avclass_output)
                    output_file.write("\n" + "=" * 40 + "\n")  # Separator for readability
                else:
                    print(f"Skipping {json_file} due to an error.")

    print(f"AVClass results saved to {OUTPUT_FILE}")
